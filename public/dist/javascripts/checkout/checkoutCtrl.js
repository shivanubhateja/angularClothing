angular.module("mainApp").controller("checkoutCtrl",["$scope","$stateParams","$rootScope","$state","productService","cartRelatedServices",function(a,e,t,r,s,i){a.cartDetails=JSON.parse(localStorage.getItem("finalCart")),a.cartDetailsRefined=[],a.forms={},a.availableProducts=0,a.fewProductsUnavailable=!1,t.hideCartFromNavBar=!0,a.totalAmount=0,t.cartDropDownVisible=!1,a.addressDetails={},a.productIds=_.pluck(a.cartDetails,"productId"),a.onload=function(){a.checkForsizeAvailability()},a.checkForsizeAvailability=function(){a.getSizes(a.productIds)},a.saveTempOrder=function(){i.saveTempOrder(a.finalCartAvailable,a.addressDetails,a.totalAmount)},a.getSizes=function(e){a.finalCartAvailable=[],a.finalCartNotAvailable=[],s.fetchAvailableSizes(e).then(function(e){a.sizesObject={},_.each(e.data.result,function(e){a.sizesObject[e.id]=e.sizes});for(var t=0;t<a.cartDetails.length;t++)a.sizesObject[a.cartDetails[t].productId][a.cartDetails[t].size]>=a.cartDetails[t].quantity?(a.cartDetails[t].available=!0,a.availableProducts++,a.totalAmount+=a.cartDetails[t].quantity*a.cartDetails[t].productDetails.price,a.finalCartAvailable.push(a.cartDetails[t])):(a.cartDetails[t].available=!1,a.fewProductsUnavailable=!0,a.cartDetails[t].remainingQuantity=a.sizesObject[a.cartDetails[t].productId][a.cartDetails[t].size],a.finalCartNotAvailable.push(a.cartDetails[t]))},function(a){})},a.checkIfAddressIsAlreadyStoredInDevice=function(){var e=localStorage.getItem("address");e?(a.newAddress=!1,a.addressDetails=JSON.parse(e)):a.newAddress=!0},a.placeOrderAndPayButtonClicked=function(){a.showErrors=!0,a.newAddress&&!a.forms.addressForm.$valid||(localStorage.setItem("address",JSON.stringify(a.addressDetails)),a.saveTempOrder(),paymentsStatus=!1,paymentsStatus&&(localStorage.removeItem("finalCart"),"buyNow"!==e.src&&(localStorage.setItem("cartDetails",JSON.stringify([])),t.numberOfProductsInCart=0),r.go("orderStatus",{orderId:"af"})))},a.$on("$stateChangeStart",function(){t.hideCartFromNavBar=!1}),a.differentAddressButton=function(){localStorage.removeItem("address"),a.newAddress=!0,a.addressDetails={}},null===a.cartDetails?r.go("homePage"):(a.onload(),a.checkIfAddressIsAlreadyStoredInDevice())}]);